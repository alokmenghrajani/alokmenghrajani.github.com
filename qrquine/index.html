<!DOCTYPE html>
<html lang="en">
<head>
  <title>Alok Menghrajani's stuff | qrquine</title>
  <meta property="fb:admins" content="536181839"/>
  <meta name="author" content="Alok Menghrajani"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="../bootstrap-responsive.min.css" rel="stylesheet">
  <link href="../bootstrap-2.3.1.min.css" rel="stylesheet"/>
  <link href="../alok.css" rel="stylesheet"/>
  <script type="text/javascript" src="../jquery-1.7.1.min.js"></script>
</head>
<body>
  <div class="container-narrow">
    <div class="menu visible-desktop">
      <div class="profile">
        <p class="pull-right"><a href="../">&larr; Back to home</a></p>
      </div>
    </div>

    <div class="jumbotron">
      <h1>qrquine</h1>
      <div class="lead">
        <p>
          Have you ever tried to embed a QR code inside a QR code?
        </p>
        <p>
          Quines are little programs which produce copies of themselves. I figured it would be fun and challenging to try to make a QR code quine.
        </p>
        <p>
          My QR code contains a piece of javascript which is able to re-generate the same QR code. The javascript is encoded as a data URI. It code reads itself
          (via location.href) and then generates the same QR code image, ad infinitum.
        </p>
        <p>
          I started with <a href="https://github.com/jeromeetienne/jquery-qrcode/blob/master/src/qrcode.js" class="external">Jerome Etienne's qrcode.js</a> library,
          and rewrote the code in a size optimized way. I had to do this because QR codes can only contain a limited number of bytes. My final code is roughly 20x smaller (from ~28000 to ~1500 bytes)!
        </p>
      </div>
    </div>

    <section>
      <img src="qrquine.png">
      <br><br><p>Note: some older phones may have trouble scanning such a large code. It works on my shiny new iPhone 5S. You can always feed the image to an
        <a href="http://blog.qr4.nl/Online-QR-Code_Decoder.aspx" class="external">online QR code service</a>.
      </p>
    </section>

    <section>
      <div class="page-header"><h3>The javascript</h3></div>
      <p>Here is the data which is embedded in the above image.</p>
      <p><a href="https://github.com/alokmenghrajani/alokmenghrajani.github.com/blob/master/qrquine/work/">You can also trace the steps I took to achieve this.</p>
      <pre>
data:text/html,&lt;body style=padding:9&gt;&lt;canvas id=C&gt;&lt;script&gt;function P(r,c,v){I[A*r+c]=v;return!(v&amp;&amp;C.getContext('2d').fillRect(c*3,r*3,3,3))}function S(i,j){for(r=O;r&lt;8;r++)for(c=O;c&lt;8;c++)j+c&gt;O&amp;&amp;j+c&lt;A&amp;&amp;P(i+r,j+c,0&lt;r&amp;&amp;(r&lt;7&amp;&amp;!(c%6))||((c+1)%8&amp;&amp;!(r%6)||1&lt;r&amp;&amp;(r&lt;5&amp;&amp;(1&lt;c&amp;&amp;c&lt;5))))}function N(a,b){if(a[L]&lt;b[L])return a;o=a[0]/b[0];for(i=0;i&lt;b[L];a[i++]^=z){m=b[i];n=o;for(z=0;m;n&gt;255&amp;&amp;(n^=285))m&amp;1&amp;&amp;(z^=n),n&lt;&lt;=1,m&gt;&gt;=1;}a.shift();return N(a,b)}C.height=C.width=(A=133)*3;I=[];X=O=-1;L='length';S(0,0);S(A-7,0);S(i=0,A-7);for(B=[6,30,54,78,102,126];i&lt;6;i++)for(j=0;j&lt;6;j++)if(!I[A*B[i]+B[j]])for(r=-2;r&lt;3;r++)for(c=-2;c&lt;3;c++)P(B[i]+r,B[j]+c,r&amp;&amp;!(r%2)||c&amp;&amp;!(c%2)||!r&amp;&amp;!c);for(i=8;i&lt;A-8;P(6,i++,j))j=!(i%2),P(i,6,j);for(i=0;i&lt;15;i++)j=29427&gt;&gt;i&amp;1,i&lt;6&amp;&amp;P(i,8,j)||i&lt;8&amp;&amp;P(i+1,8,j)||P(118+i,8,j),i&lt;8&amp;&amp;P(8,A-i-1,j)||i&lt;9&amp;&amp;P(8,15-i,j)||P(8,14-i,j);P(A-8,8,1);for(i=0;i&lt;18;P(i%3+A-11,i++/3|0,k))k=119615&gt;&gt;i&amp;1,P(i/3|0,i%3+A-11,k);for(D=[4,i=0,6,0,6];i&lt;1542;D=D.concat([j&gt;&gt;4,j&amp;15]))j=unescape(location.href).charCodeAt(i++);D.push(r=0);for(E=3262;D[L]&lt;E;D=D.concat([1,1]))D=D.concat([14,12]);F=[];for(Z=k=r=0;r&lt;14;r++){i=116+(r&gt;6);l=[];for(j=0;j&lt;i;F[r+j*14-(j&gt;115?7:0)]=l[j++])l[j]=(D[k++]&lt;&lt;4)|D[k++];l=l.concat(new Array(30));for(j=0;j&lt;30;j++)F[r+j*14+1631]=N(l,[1,212,246,77,73,195,192,75,98,5,70,103,177,22,217,138,51,181,246,72,25,18,46,228,74,216,195,11,106,130,150])[j]}Y=7;for(x=i=A-1;i&gt;0;i-=2){for(i==6&amp;&amp;i--;x&gt;O&amp;&amp;x&lt;A;x+=X)for(j=0;j&lt;2;j++)if(I[A*x+i-j]==B[9])k=Z&lt;F[L]&amp;&amp;F[Z]&gt;&gt;Y&amp;1,P(x,i-j,x%2?k:!k),--Y&lt;0&amp;&amp;(Z++,Y=7);x-=X;X=-X}console.log('-- Alok')&lt;/script&gt;</pre>
    </section>

    <section>
      <h3>links</h3>
      <ul>
        <li><a href="http://en.wikipedia.org/wiki/Quine_(computing)">Read more about quines</a></li>
        <li><a href="https://github.com/jeromeetienne/jquery-qrcode/blob/master/src/qrcode.js">Open source qrcode library in JS</a></li>
        <li><a href="http://en.wikipedia.org/wiki/QR_code">Information about QR codes</a></li>
        <li><a href="http://www.qrcode.com/en/about/version.html">More information about QR codes</a></li>
      </ul>

      <small>
        The word "QR Code" is registered trademark of DENSO WAVE INCORPORATED (http://www.denso-wave.com/qrcode/)
      </small>
    </section>

    <footer class="footer">
      <div style="float: left" class="fb-like" data-send="false" data-width="450" data-show-faces="false"></div>
      <p class="pull-right visible-desktop">
        <a href="https://github.com/alokmenghrajani/alokmenghrajani.github.com/issues/new">contact me</a>
        <span class="vbar"></span>
        <a href="#">back to top &uarr;</a>
      </p>
    </footer>
  </div>

  <script type="text/javascript" src="https://cdn.firebase.com/v0/firebase.js"></script>
  <script type="text/jsx" src="wait_or_join.js"></script>
  <script type="text/jsx" src="cell.js"></script>
  <script type="text/jsx" src="tictactoe.js"></script>
  <script type="text/jsx" src="chat.js"></script>
  <script type="text/jsx" src="game.js"></script>
  <script type="text/jsx">
    /**
     * @jsx React.DOM
     */

    function StartGame() {
      this.started = false;

      // Start Firebase only once the page is visible. I was running into "ghost" users issues
      // without this.

      // Set the name of the hidden property and the change event for visibility
      this.hidden = "undefined";
      var visibilityChange;
      if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
        this.hidden = "hidden";
        visibilityChange = "visibilitychange";
      } else if (typeof document.mozHidden !== "undefined") {
        this.hidden = "mozHidden";
        visibilityChange = "mozvisibilitychange";
      } else if (typeof document.msHidden !== "undefined") {
        this.hidden = "msHidden";
        visibilityChange = "msvisibilitychange";
      } else if (typeof document.webkitHidden !== "undefined") {
        this.hidden = "webkitHidden";
        visibilityChange = "webkitvisibilitychange";
      }

      // Check if the browser supports addEventListener and Page Visibility API
      if (typeof document.addEventListener === "undefined" ||
          typeof this.hidden === "undefined") {
        this.go();
      } else {
        // Handle page visibility change
        document.addEventListener(visibilityChange, this.handleVisibilityChange.bind(this), false);
        // Call it once in case we started out visible.
        this.handleVisibilityChange();
      }
    }

    StartGame.prototype.handleVisibilityChange = function() {
      // if the page is shown, start the game
      if (!document[this.hidden]) {
        if (!this.started) {
          this.started = true;
          this.go();
        }
      }
    }

    StartGame.prototype.go = function() {
      console.log("StartGame: go");
      var firebase = new Firebase('https://reacttictactoe.firebaseIO-demo.com/');
      var path = firebase.child('users').push();
      path.onDisconnect().remove(
        function(err) {
          if (err) {
            console.log("onDisconnect failed: "+err);
            throw err;
          }
          var status = path.set(true);
          var id = path.name();

          // leak these for debugging purpose
          game = React.renderComponent(<Game id={id}/>, document.getElementById('game'));
          alok = new WaitOrJoin(
            id,
            firebase,
            game.onConnect.bind(game),
            game.onDisconnect.bind(game)
          );
        }.bind(this)
      );
    }
    new StartGame();
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-2373559-12', 'quaxio.com');
  ga('send', 'pageview');
</script>

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=202717489767277";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

  </body>
</html>
